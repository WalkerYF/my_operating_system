     1                                  %include "../include/macro.inc"
     2                              <1> loader_code_segment equ 0x1000
     3                              <1> loader_code_entry equ 0x0000
     4                              <1> 
     5                              <1> 
     6                              <1> core_header_data_segment equ 0100h
     7                              <1> core_code_entry_header_offset equ 0x2A
     8                              <1> core_code_segment_header_offset equ 0x2C
     9                              <1> core_data_segment_header_offset equ 0x2E
    10                              <1> core_stack_segment_header_offset equ 0x30
    11                              <1> core_stack_length equ 256
    12                              <1> core_entry_header_offset equ 0x32
    13                              <1> user1_program_address equ 0x2000
    14                              <1> user2_program_address equ 0x3000
    15                              <1> user3_program_address equ 0x4000
    16                              <1> user4_program_address equ 0x5000
    17                              <1> 
    18                              <1> user1_bound_x_up equ 1 
    19                              <1> user1_bound_x_down equ 12
    20                              <1> user1_bound_y_left equ 1
    21                              <1> user1_bound_y_right equ 39 
    22                              <1> 
    23                              <1> user2_bound_x_up equ 1 
    24                              <1> user2_bound_x_down equ 12
    25                              <1> user2_bound_y_left equ 40
    26                              <1> user2_bound_y_right equ 78 
    27                              <1> 
    28                              <1> user3_bound_x_up equ 13 
    29                              <1> user3_bound_x_down equ 23
    30                              <1> user3_bound_y_left equ 1
    31                              <1> user3_bound_y_right equ 39
    32                              <1> 
    33                              <1> user4_bound_x_up equ 13 
    34                              <1> user4_bound_x_down equ 23
    35                              <1> user4_bound_y_left equ 40
    36                              <1> user4_bound_y_right equ 78 
    37                                  section my_user1_program_header vstart=0x10000
    38                                      delay equ 50000					; 计时器延迟计数,用于控制画框的速度
    39                                      ddelay equ 5					; 计时器延迟计数,用于控制画框的速度
    40                                  start:
    41                                  	;xor ax,ax					; AX = 0   程序加载到0000：100h才能正确执行
    42 00000000 8CC8                        mov ax,cs
    43 00000002 8ED8                    	mov ds,ax					; DS = CS
    44 00000004 8EC0                    	mov es,ax					; ES = CS
    45 00000006 B800B8                  	mov ax,0B800h				; 文本窗口显存起始地址
    46 00000009 8EE8                    	mov gs,ax					; GS = B800h
    47 0000000B E81501                  	call clean_screen
    48                                  
    49 0000000E B80113                  	mov ax, 1301h		 ; AH = 13h（功能号）、AL = 01h（光标置于串尾）
    50 00000011 BB0700                  	mov bx, 0007h		 ; 页号为0(BH = 0) 黑底白字(BL = 07h)
    51 00000014 B202                    	mov dl, 2 		 ; 列号=0
    52 00000016 B617                    	mov dh, 23		       ; 行号=0
    53 00000018 B94F00                  	mov cx, user1_MessageLength  ; CX = 串长（=9）
    54 0000001B BD[2000]                	mov bp, user1_Message		 ; es:BP=当前串的偏移地址
    55 0000001E CD10                    	int 10h			 ; BIOS的10h功能：显示一行字符
    56                                  
    57                                  user1_Message:
    58 00000020 456E74657220712074-         db 'Enter q to return system menu!                                                 '
    59 00000029 6F2072657475726E20-
    60 00000032 73797374656D206D65-
    61 0000003B 6E7521202020202020-
    62 00000044 202020202020202020-
    63 0000004D 202020202020202020-
    64 00000056 202020202020202020-
    65 0000005F 202020202020202020-
    66 00000068 20202020202020     
    67                                  user1_MessageLength equ ($-user1_Message)
    68                                  
    69                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    70                                  loop1:
    71 0000006F FF0E[5101]              	dec word[count]			; 递减计数变量
    72 00000073 75FA                    	jnz loop1					; >0：跳转;
    73 00000075 C706[5101]50C3          	mov word[count],delay
    74 0000007B FF0E[5301]              	dec word[dcount]			; 递减计数变量
    75 0000007F 75EE                          jnz loop1
    76 00000081 C706[5101]50C3          	mov word[count],delay
    77 00000087 C706[5301]0500          	mov word[dcount],ddelay
    78                                  
    79                                  check_keyboard:
    80 0000008D B401                        mov ah, 01h
    81 0000008F CD16                        int 16h
    82                                      ; 不断查询键盘缓冲区的状况
    83                                      ; 若有按键，则zf为0，若无按键，则zf为1，跳回去继续查询
    84 00000091 740A                        jz clean_current_char
    85                                      ; 有字符输入,从al中读取键盘输入
    86 00000093 B400                        mov ah, 00h
    87 00000095 CD16                        int 16h
    88                                  
    89 00000097 3C71                        cmp al, 'q' ; 如果键入q则退出
    90 00000099 75F2                        jnz check_keyboard
    91 0000009B CD40                    	int 40h
    92                                  clean_current_char: ; 清除当前字母所占显存位置,准备画下一个字母显存
    93 0000009D 31C0                          xor ax,ax                 ; 计算显存地址
    94 0000009F A1[5701]                      mov ax,word[x]
    95 000000A2 BB5000                  	mov bx,80
    96 000000A5 F7E3                    	mul bx
    97 000000A7 0306[5B01]              	add ax,word[y]
    98 000000AB BB0200                  	mov bx,2
    99 000000AE F7E3                    	mul bx
   100 000000B0 89C3                    	mov bx,ax
   101 000000B2 B407                    	mov ah,07h				
   102 000000B4 B020                    	mov al,20h		
   103 000000B6 658907                  	mov [gs:bx],ax  		;  显示字符的ASCII码值
   104                                  
   105                                  check_x:
   106 000000B9 B80100                      mov ax, user1_bound_x_up
   107 000000BC 3906[5701]                  cmp word [x], ax
   108 000000C0 740B                        jz toggle_x_direct
   109 000000C2 B80C00                      mov ax, user1_bound_x_down
   110 000000C5 3906[5701]                  cmp word [x], ax
   111 000000C9 7402                        jz toggle_x_direct
   112 000000CB EB0A                        jmp check_y
   113                                  toggle_x_direct:
   114 000000CD B80000                      mov ax, 0
   115 000000D0 2B06[5501]                  sub ax, word [x_direct]
   116 000000D4 A3[5501]                    mov word [x_direct], ax
   117                                  check_y:
   118 000000D7 B80100                      mov ax, user1_bound_y_left
   119 000000DA 3906[5B01]                  cmp word [y], ax
   120 000000DE 740B                        jz toggle_y_direct
   121 000000E0 B82700                      mov ax, user1_bound_y_right
   122 000000E3 3906[5B01]                  cmp word [y], ax
   123 000000E7 7402                        jz toggle_y_direct
   124 000000E9 EB0A                        jmp char_move
   125                                  toggle_y_direct:    
   126 000000EB B80000                      mov ax, 0
   127 000000EE 2B06[5901]                  sub ax, word [y_direct]
   128 000000F2 A3[5901]                    mov word [y_direct], ax
   129                                  
   130                                  char_move:
   131 000000F5 A1[5501]                    mov ax, word [x_direct]
   132 000000F8 0106[5701]                  add word [x], ax
   133 000000FC A1[5901]                    mov ax, word [y_direct]
   134 000000FF 0106[5B01]                  add word [y], ax
   135                                  show:	
   136 00000103 31C0                        xor ax,ax                 ; 计算显存地址
   137 00000105 A1[5701]                    mov ax,word[x]
   138 00000108 BB5000                  	mov bx,80
   139 0000010B F7E3                    	mul bx
   140 0000010D 0306[5B01]              	add ax,word[y]
   141 00000111 BB0200                  	mov bx,2
   142 00000114 F7E3                    	mul bx
   143 00000116 89C3                    	mov bx,ax
   144 00000118 88FC                    	mov ah,bh				;  0000：黑底、1111：亮白字（默认值为07h）
   145 0000011A A0[5D01]                	mov al,byte[char]			;  AL = 显示字符值（默认值为20h=空格符）
   146 0000011D 658907                  	mov [gs:bx],ax  		;  显示字符的ASCII码值
   147 00000120 E94CFF                  	jmp loop1
   148                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   149                                  ; 清屏函数
   150                                  ; 被调用函数不保存任何寄存器,需要改进	
   151                                  clean_screen:
   152                                  	; 存放寄存器
   153 00000123 50                      	push ax
   154 00000124 51                      	push cx
   155 00000125 56                      	push si
   156 00000126 06                      	push es
   157                                  	; 设置段寄存器
   158 00000127 B800B8                  	mov ax, 0xB800
   159 0000012A 8EC0                    	mov es, ax
   160 0000012C B9D007                  	mov cx, 2000
   161 0000012F BE0000                  	mov si, 0
   162                                  clean_screen_loop:
   163 00000132 26C60420                	mov byte [es:si], 20h
   164 00000136 46                      	inc si
   165 00000137 26C60407                	mov byte [es:si], 07h
   166 0000013B 46                      	inc si
   167 0000013C E2F4                    	loop clean_screen_loop
   168                                  clean_screen_exit:
   169                                  
   170 0000013E B800B8                      mov ax, 0b800h
   171 00000141 8EC0                        mov es, ax
   172 00000143 B80207                      mov ax, 0702h
   173 00000146 26A30000                    mov [es:0x00], ax
   174                                  
   175 0000014A 07                      	pop es
   176 0000014B 5E                      	pop si
   177 0000014C 59                      	pop cx
   178 0000014D 58                      	pop ax
   179 0000014E C3                      	ret
   180                                  
   181                                  end:
   182 0000014F EBFE                        jmp $                   ; 停止画框，无限循环 
   183                                  
   184                                  datadef:	
   185 00000151 50C3                        count dw delay
   186 00000153 0500                        dcount dw ddelay
   187                                      ; rdul db Dn_Rt         ; 向右下运动
   188 00000155 0100                        x_direct    dw 1
   189 00000157 0200                        x dw user1_bound_x_up+1
   190 00000159 0100                        y_direct    dw 1
   191 0000015B 0200                        y dw user1_bound_y_left+1
   192 0000015D 02                          char db 2
   193                                  
