# 操作系统week3-2

之前花了挺长时间弄清楚了如何将C和汇编混合编译并放入扇区使用虚拟机运行。
现在先看看这个周末要把这个操作系统开发到什么程度吧。

## 想法

跑步进入保护模式

### 各部件分工l

其实我发现现在我还不清楚各部件的分工，还有内存的安排，内核放哪？gdt表放哪？在进入保护模式前
这里先明确一下。

boot：0x7c00-0x7e00
    只做引导功能，将加载器加载进内存的0x10000的区域。
    放到(0,1,1-18) 实际上只有9KB

loader:0x8000-0x10000 （硬盘里只有9KB）
    进入保护模式，初始化gdt，先完成几项。gdt放在0x1000-0x5000中
    指定内核代码段，数据段，栈段的位置，写成常数，这个应该在loader中初始化段表的时候完成。
    然后跳入内核。

kernel:加载到0x10000 - 0x50000
    已经进入保护模式了。
    内核应该要做什么？我暂时的作用就是通过按键加载用户程序到内存指定位置。还有实现关机。
    那应该要怎么实现呢？由于我已经进入了保护模式，原有的bios中断已经不再能够使用，我是不是要设置各种IDT，可能还要重新设置GDT？

用户程序：指定加载到0x50000处
    命令行终端，属于一个用户程序（可以说是root级别）。
    通过包含库文件，里面可以通过调用各种系统调用，实现各种功能。
bash:
    命令行终端，应该是运行在操作系统上的一个程序。

实现什么库函数：

### 软盘位置安排

(1,2,3):X 表示1面2道3扇区,逻辑扇区号为X

(0,0,1):0:主引导扇区
(0,0,2-18)
(1,0,1):(1-18):FAT表

(0,1,1-18):(36-53):加载器

(1,1,1-18):(54-71):内核

### boot.asm 已完成

将(1,0,1-18)加载到内存0x0800:0x0000处，该常量定义在marco.inc内
出现过的问题：柱面号和磁头号写反了。

### loader.asm

1. jmp进loader后，cs:ip为0x1000：0x0000
1. 设置GDT表，放在0x1000中

遇到的问题为：
我本来想loader进入保护模式之后就加载扇区，然后跳到地址为0x100000的地方
一想，如果不在32位代码下跑，我没法将地址指定为0x100000啊
还有，在保护模式下，我也没法调用中断，将扇区加载到指定地址处啊。
如果说我要在保护模式前加载，我根本无法寻址到1mb之外的地方，更别提加载扇区到这个地方了。

怎么解决呢？
需要进一步明确加载器的职能。

在加载器中，目前初始化了一个临时的gdt表。

诶，我就加了点注释，怎么就出问题了。de出来了，是因为我的代码cs已经设置好了，所以在代码里就不用再显式的说明我在哪里开始了，做的改变就是：把vstart=0x10000删掉。

### 继续写loader.asm

明确loader职责，为kernel做准备。
内核加载到0x10000的地方吧，不然障碍太大了。

1. 在进入保护模式前,将内核所在扇区加载到0x10000
1. 初始化gdt表
1. 跳到内核开始运行。

## 记录

### 保护模式中各种描述符

1. 段描述符
    1. 《从实模式到保护模式》P188 ![](https://i.loli.net/2018/03/24/5ab5beae3d320.png)
1. 段选择子
    1. 《从实模式到保护模式》P197 ![](https://i.loli.net/2018/03/24/5ab5be3e427c9.png)

### 一个问题：

call时，地址会push进栈中，这个时候是如何进栈的？是高字节先进吗，还是低字节先进？