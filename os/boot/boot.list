     1                                  ;程序源代码（myos1.asm）
     2                                  ; org  7c00h		; BIOS将把引导扇区加载到0:7C00h处，并开始执行
     3                                  %include "../include/macro.inc"
     4                              <1> ROOTENTCNT equ 64
     5                              <1> 
     6                              <1> loader_code_segment equ 0x0800
     7                              <1> loader_code_entry equ 0x0000
     8                              <1> kernel_code_segment equ 0x1000
     9                              <1> kernel_code_entry equ 0x0000
    10                              <1> 
    11                              <1> fsystem_code_segment equ 0x0100
    12                              <1> fsystem_code_entry equ 0x0000 
    13                              <1> 
    14                              <1> core_header_data_segment equ 1000h
    15                              <1> 
    16                              <1> core_code_entry_header_offset equ 0x2A
    17                              <1> core_code_segment_header_offset equ 0x2C
    18                              <1> core_data_segment_header_offset equ 0x2E
    19                              <1> core_stack_segment_header_offset equ 0x30
    20                              <1> 
    21                              <1> core_stack_length equ 256
    22                              <1> core_entry_header_offset equ 0x32
    23                              <1> 
    24                              <1> user_program_segment equ 0x5000
    25                              <1> 
    26                              <1> user1_bound_x_up equ 1 
    27                              <1> user1_bound_x_down equ 12
    28                              <1> user1_bound_y_left equ 1
    29                              <1> user1_bound_y_right equ 39 
    30                              <1> 
    31                              <1> user2_bound_x_up equ 1 
    32                              <1> user2_bound_x_down equ 12
    33                              <1> user2_bound_y_left equ 40
    34                              <1> user2_bound_y_right equ 78 
    35                              <1> 
    36                              <1> user3_bound_x_up equ 13 
    37                              <1> user3_bound_x_down equ 23
    38                              <1> user3_bound_y_left equ 1
    39                              <1> user3_bound_y_right equ 39
    40                              <1> 
    41                              <1> user4_bound_x_up equ 13 
    42                              <1> user4_bound_x_down equ 23
    43                              <1> user4_bound_y_left equ 40
    44                              <1> user4_bound_y_right equ 78 
    45                              <1> 
    46                              <1> %macro retl 0
    47                              <1>     db 0x66
    48                              <1>     ret
    49                              <1> %endmacro
    50                                  section my_mbr vstart=0x7c00
    51                                  
    52 00000000 EB35                    jmp short LABEL_START		; Start to boot.
    53 00000002 90                      nop				; 这个 nop 不可少
    54                                  
    55                                  ; 下面是 FAT12 磁盘的头
    56 00000003 5759462020202020        BS_OEMName	DB 'WYF     '	; OEM String, 必须 8 个字节
    57 0000000B 0002                    BPB_BytsPerSec	DW 512		; 每扇区字节数
    58 0000000D 01                      BPB_SecPerClus	DB 1		; 每簇多少扇区
    59 0000000E 0100                    BPB_RsvdSecCnt	DW 1		; Boot 记录占用多少扇区
    60 00000010 02                      BPB_NumFATs	DB 2		; 共有多少 FAT 表
    61 00000011 4000                    BPB_RootEntCnt	DW ROOTENTCNT		; 根目录文件数最大值
    62 00000013 400B                    BPB_TotSec16	DW 2880		; 逻辑扇区总数
    63 00000015 F0                      BPB_Media	DB 0xF0		; 媒体描述符
    64 00000016 0900                    BPB_FATSz16	DW 9		; 每FAT扇区数
    65 00000018 1200                    BPB_SecPerTrk	DW 18		; 每磁道扇区数
    66 0000001A 0200                    BPB_NumHeads	DW 2		; 磁头数(面数)
    67 0000001C 00000000                BPB_HiddSec	DD 0		; 隐藏扇区数
    68 00000020 00000000                BPB_TotSec32	DD 0		; 如果 wTotalSectorCount 是 0 由这个值记录扇区数
    69 00000024 00                      BS_DrvNum	DB 0		; 中断 13 的驱动器号
    70 00000025 00                      BS_Reserved1	DB 0		; 未使用
    71 00000026 29                      BS_BootSig	DB 29h		; 扩展引导标记 (29h)
    72 00000027 00000000                BS_VolID	DD 0		; 卷序列号
    73 0000002B 4D594F53                BS_VolLab	DB 'MYOS'; 卷标, 必须 11 个字节
    74 0000002F 4641543132202020        BS_FileSysType	DB 'FAT12   '	; 文件系统类型, 必须 8个字节  
    75                                  
    76                                  LABEL_START:
    77 00000037 8CC8                    	mov ax, cs	       ; 置其他段寄存器值与CS相同
    78 00000039 8ED8                    	mov ds, ax	       ; 数据段
    79 0000003B 8EC0                    	mov es, ax		 ; 置ES=DS
    80                                      ; 显示字符串
    81                                      ; 此时es 就是0，与cs相同
    82 0000003D 66B801130000            	mov eax, 1301h		 ; AH = 13h（功能号）、AL = 01h（光标置于串尾）
    83 00000043 66BB07000000            	mov ebx, 0007h		 ; 页号为0(BH = 0) 黑底白字(BL = 07h)
    84 00000049 B200                    	mov dl, 0			 ; 列号=0
    85 0000004B B600                    	mov dh, 0		       ; 行号=0
    86 0000004D B92300                  	mov cx, MessageLength  ; CX = 串长（=9）
    87 00000050 BD[7C00]                	mov bp, Message		 ; BP=当前串的偏移地址
    88 00000053 CD10                    	int 10h			 ; BIOS的10h功能：显示一行字符
    89                                  
    90                                  LoadnEx:
    91                                       ;读软盘或硬盘上的若干物理扇区到内存的ES:BX处：
    92 00000055 B80010                  	mov ax,kernel_code_segment  ;段地址 ; 存放数据的内存基地址
    93 00000058 8EC0                    	mov es,ax                ;设置段地址（不能直接mov es,段地址）
    94 0000005A BB0000                  	mov bx,0 ;偏移地址; 存放数据的内存偏移地址
    95 0000005D B402                    	mov ah,2                 ; 功能号
    96 0000005F B012                    	mov al,18                ;扇区数
    97 00000061 B200                    	mov dl,0                 ;驱动器号 ; 软盘为0，硬盘和U盘为80H
    98 00000063 B600                    	mov dh,0                 ;磁头号 ; 起始编号为0
    99 00000065 B502                    	mov ch,2                 ;柱面号 ; 起始编号为0
   100 00000067 B101                    	mov cl,1                 ;起始扇区号 ; 起始编号为1
   101 00000069 CD13                    	int 13H ;                调用读磁盘BIOS的13h功能
   102                                  	; 系统内核已加载到指定内存区域中	
   103                                  ; LoadnEx2:
   104                                  ;      ;读软盘或硬盘上的若干物理扇区到内存的ES:BX处：
   105                                  ; 	mov ax,user_program_segment ;段地址 ; 存放数据的内存基地址
   106                                  ; 	mov es,ax                ;设置段地址（不能直接mov es,段地址）
   107                                  ; 	mov bx,0 ;偏移地址; 存放数据的内存偏移地址
   108                                  ; 	mov ah,2                 ; 功能号
   109                                  ; 	mov al,18                ;扇区数
   110                                  ; 	mov dl,0                 ;驱动器号 ; 软盘为0，硬盘和U盘为80H
   111                                  ; 	mov dh,1                 ;磁头号 ; 起始编号为0
   112                                  ; 	mov ch,2                 ;柱面号 ; 起始编号为0
   113                                  ; 	mov cl,1                 ;起始扇区号 ; 起始编号为1
   114                                  ; 	int 13H ;                调用读磁盘BIOS的13h功能
   115                                  ; 	; 系统内核已加载到指定内存区域中
   116                                  
   117                                  ; 转入系统内核
   118                                  inkernel:
   119 0000006B B80010                      mov ax, 1000h
   120 0000006E 8ED8                        mov ds, ax
   121 00000070 8EC0                        mov es, ax
   122 00000072 8ED0                        mov ss, ax
   123 00000074 BC0050                      mov sp, 5000h
   124 00000077 EA00000010              	jmp kernel_code_segment:kernel_code_entry
   125                                  Message:
   126 0000007C 48656C6C6F2C204D79-     	db 'Hello, MyOs is loading system core.'
   127 00000085 4F73206973206C6F61-
   128 0000008E 64696E672073797374-
   129 00000097 656D20636F72652E   
   130                                  MessageLength  equ ($-Message)
   131 0000009F 00<rept>                times 510-($-$$) db 0
   132 000001FE 55AA                    db 0x55,0xaa
   133                                  
   134                                  
   135                                  
   136                                  
   137                                  
