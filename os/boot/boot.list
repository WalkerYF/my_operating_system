     1                                  ;程序源代码（myos1.asm）
     2                                  ; org  7c00h		; BIOS将把引导扇区加载到0:7C00h处，并开始执行
     3                                  %include "../include/macro.inc"
     4                              <1> loader_code_segment equ 0x0800
     5                              <1> loader_code_entry equ 0x0000
     6                              <1> kernel_code_segment equ 0x1000
     7                              <1> kernel_code_entry equ 0x0000
     8                              <1> 
     9                              <1> fsystem_code_segment equ 0x0100
    10                              <1> fsystem_code_entry equ 0x0000 
    11                              <1> 
    12                              <1> core_header_data_segment equ 1000h
    13                              <1> 
    14                              <1> core_code_entry_header_offset equ 0x2A
    15                              <1> core_code_segment_header_offset equ 0x2C
    16                              <1> core_data_segment_header_offset equ 0x2E
    17                              <1> core_stack_segment_header_offset equ 0x30
    18                              <1> 
    19                              <1> core_stack_length equ 256
    20                              <1> core_entry_header_offset equ 0x32
    21                              <1> 
    22                              <1> user_program_segment equ 0x5000
    23                              <1> 
    24                              <1> user1_bound_x_up equ 1 
    25                              <1> user1_bound_x_down equ 12
    26                              <1> user1_bound_y_left equ 1
    27                              <1> user1_bound_y_right equ 39 
    28                              <1> 
    29                              <1> user2_bound_x_up equ 1 
    30                              <1> user2_bound_x_down equ 12
    31                              <1> user2_bound_y_left equ 40
    32                              <1> user2_bound_y_right equ 78 
    33                              <1> 
    34                              <1> user3_bound_x_up equ 13 
    35                              <1> user3_bound_x_down equ 23
    36                              <1> user3_bound_y_left equ 1
    37                              <1> user3_bound_y_right equ 39
    38                              <1> 
    39                              <1> user4_bound_x_up equ 13 
    40                              <1> user4_bound_x_down equ 23
    41                              <1> user4_bound_y_left equ 40
    42                              <1> user4_bound_y_right equ 78 
    43                              <1> 
    44                              <1> %macro retl 0
    45                              <1>     db 66h
    46                              <1>     ret
    47                              <1> %endmacro
    48                                  section my_mbr vstart=0x7c00
    49                                  Start:
    50 00000000 8CC8                    	mov ax, cs	       ; 置其他段寄存器值与CS相同
    51 00000002 8ED8                    	mov ds, ax	       ; 数据段
    52 00000004 8EC0                    	mov es, ax		 ; 置ES=DS
    53                                      ; 显示字符串
    54                                      ; 此时es 就是0，与cs相同
    55 00000006 66B801130000            	mov eax, 1301h		 ; AH = 13h（功能号）、AL = 01h（光标置于串尾）
    56 0000000C 66BB07000000            	mov ebx, 0007h		 ; 页号为0(BH = 0) 黑底白字(BL = 07h)
    57 00000012 B200                    	mov dl, 0			 ; 列号=0
    58 00000014 B600                    	mov dh, 0		       ; 行号=0
    59 00000016 B92300                  	mov cx, MessageLength  ; CX = 串长（=9）
    60 00000019 BD[5B00]                	mov bp, Message		 ; BP=当前串的偏移地址
    61 0000001C CD10                    	int 10h			 ; BIOS的10h功能：显示一行字符
    62                                  LoadnEx:
    63                                       ;读软盘或硬盘上的若干物理扇区到内存的ES:BX处：
    64 0000001E B80010                  	mov ax,kernel_code_segment  ;段地址 ; 存放数据的内存基地址
    65 00000021 8EC0                    	mov es,ax                ;设置段地址（不能直接mov es,段地址）
    66 00000023 BB0000                  	mov bx,0 ;偏移地址; 存放数据的内存偏移地址
    67 00000026 B402                    	mov ah,2                 ; 功能号
    68 00000028 B00A                    	mov al,10                ;扇区数
    69 0000002A B200                    	mov dl,0                 ;驱动器号 ; 软盘为0，硬盘和U盘为80H
    70 0000002C B600                    	mov dh,0                 ;磁头号 ; 起始编号为0
    71 0000002E B502                    	mov ch,2                 ;柱面号 ; 起始编号为0
    72 00000030 B101                    	mov cl,1                 ;起始扇区号 ; 起始编号为1
    73 00000032 CD13                    	int 13H ;                调用读磁盘BIOS的13h功能
    74                                  	; 系统内核已加载到指定内存区域中	
    75                                  LoadnEx2:
    76                                       ;读软盘或硬盘上的若干物理扇区到内存的ES:BX处：
    77 00000034 B80050                  	mov ax,user_program_segment ;段地址 ; 存放数据的内存基地址
    78 00000037 8EC0                    	mov es,ax                ;设置段地址（不能直接mov es,段地址）
    79 00000039 BB0000                  	mov bx,0 ;偏移地址; 存放数据的内存偏移地址
    80 0000003C B402                    	mov ah,2                 ; 功能号
    81 0000003E B00A                    	mov al,10                ;扇区数
    82 00000040 B200                    	mov dl,0                 ;驱动器号 ; 软盘为0，硬盘和U盘为80H
    83 00000042 B601                    	mov dh,1                 ;磁头号 ; 起始编号为0
    84 00000044 B502                    	mov ch,2                 ;柱面号 ; 起始编号为0
    85 00000046 B101                    	mov cl,1                 ;起始扇区号 ; 起始编号为1
    86 00000048 CD13                    	int 13H ;                调用读磁盘BIOS的13h功能
    87                                  	; 系统内核已加载到指定内存区域中
    88                                  
    89                                  ; 转入系统内核
    90                                  inkernel:
    91 0000004A B80010                      mov ax, 1000h
    92 0000004D 8ED8                        mov ds, ax
    93 0000004F 8EC0                        mov es, ax
    94 00000051 8ED0                        mov ss, ax
    95 00000053 BC0050                      mov sp, 5000h
    96 00000056 EA00000010              	jmp kernel_code_segment:kernel_code_entry
    97                                  Message:
    98 0000005B 48656C6C6F2C204D79-     	db 'Hello, MyOs is loading system core.'
    99 00000064 4F73206973206C6F61-
   100 0000006D 64696E672073797374-
   101 00000076 656D20636F72652E   
   102                                  MessageLength  equ ($-Message)
   103 0000007E 00<rept>                times 510-($-$$) db 0
   104 000001FE 55AA                    db 0x55,0xaa
   105                                  
   106                                  
   107                                  
   108                                  
   109                                  
