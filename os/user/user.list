     1                                  %include "../include/macro.inc"
     2                              <1> loader_code_segment equ 0x0800
     3                              <1> loader_code_entry equ 0x0000
     4                              <1> kernel_code_segment equ 0x1000
     5                              <1> kernel_code_entry equ 0x0000
     6                              <1> 
     7                              <1> fsystem_code_segment equ 0x0100
     8                              <1> fsystem_code_entry equ 0x0000 
     9                              <1> 
    10                              <1> core_header_data_segment equ 1000h
    11                              <1> 
    12                              <1> core_code_entry_header_offset equ 0x2A
    13                              <1> core_code_segment_header_offset equ 0x2C
    14                              <1> core_data_segment_header_offset equ 0x2E
    15                              <1> core_stack_segment_header_offset equ 0x30
    16                              <1> 
    17                              <1> core_stack_length equ 256
    18                              <1> core_entry_header_offset equ 0x32
    19                              <1> 
    20                              <1> user1_program_address equ 0x2000
    21                              <1> user2_program_address equ 0x3000
    22                              <1> user3_program_address equ 0x4000
    23                              <1> user4_program_address equ 0x5000
    24                              <1> 
    25                              <1> user1_bound_x_up equ 1 
    26                              <1> user1_bound_x_down equ 12
    27                              <1> user1_bound_y_left equ 1
    28                              <1> user1_bound_y_right equ 39 
    29                              <1> 
    30                              <1> user2_bound_x_up equ 1 
    31                              <1> user2_bound_x_down equ 12
    32                              <1> user2_bound_y_left equ 40
    33                              <1> user2_bound_y_right equ 78 
    34                              <1> 
    35                              <1> user3_bound_x_up equ 13 
    36                              <1> user3_bound_x_down equ 23
    37                              <1> user3_bound_y_left equ 1
    38                              <1> user3_bound_y_right equ 39
    39                              <1> 
    40                              <1> user4_bound_x_up equ 13 
    41                              <1> user4_bound_x_down equ 23
    42                              <1> user4_bound_y_left equ 40
    43                              <1> user4_bound_y_right equ 78 
    44                              <1> 
    45                              <1> %macro retl 0
    46                              <1>     db 66h
    47                              <1>     ret
    48                              <1> %endmacro
    49                                  section my_user2_program_header vstart=0x50000
    50                                      delay equ 50000					; 计时器延迟计数,用于控制画框的速度
    51                                      ddelay equ 5					; 计时器延迟计数,用于控制画框的速度
    52                                  start:
    53                                  	;xor ax,ax					; AX = 0   程序加载到0000：100h才能正确执行
    54 00000000 8CC8                        mov ax,cs
    55 00000002 8ED8                    	mov ds,ax					; DS = CS
    56 00000004 8EC0                    	mov es,ax					; ES = CS
    57 00000006 B800B8                  	mov ax,0B800h				; 文本窗口显存起始地址
    58 00000009 8EE8                    	mov gs,ax					; GS = B800h
    59 0000000B E81501                  	call clean_screen
    60                                  
    61 0000000E B80113                  	mov ax, 1301h		 ; AH = 13h（功能号）、AL = 01h（光标置于串尾）
    62 00000011 BB0700                  	mov bx, 0007h		 ; 页号为0(BH = 0) 黑底白字(BL = 07h)
    63 00000014 B228                    	mov dl, 40 		 ; 列号=0
    64 00000016 B617                    	mov dh, 23		       ; 行号=0
    65 00000018 B94F00                  	mov cx, user2_MessageLength  ; CX = 串长（=9）
    66 0000001B BD[2000]                	mov bp, user2_Message		 ; es:BP=当前串的偏移地址
    67 0000001E CD10                    	int 10h			 ; BIOS的10h功能：显示一行字符
    68                                  
    69                                  user2_Message:
    70 00000020 456E74657220712074-         db 'Enter q to return system menu!                                                 '
    71 00000029 6F2072657475726E20-
    72 00000032 73797374656D206D65-
    73 0000003B 6E7521202020202020-
    74 00000044 202020202020202020-
    75 0000004D 202020202020202020-
    76 00000056 202020202020202020-
    77 0000005F 202020202020202020-
    78 00000068 20202020202020     
    79                                  user2_MessageLength equ ($-user2_Message)
    80                                  
    81                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    82                                  loop1:
    83 0000006F FF0E[5101]              	dec word[count]			; 递减计数变量
    84 00000073 75FA                    	jnz loop1					; >0：跳转;
    85 00000075 C706[5101]50C3          	mov word[count],delay
    86 0000007B FF0E[5301]              	dec word[dcount]			; 递减计数变量
    87 0000007F 75EE                          jnz loop1
    88 00000081 C706[5101]50C3          	mov word[count],delay
    89 00000087 C706[5301]0500          	mov word[dcount],ddelay
    90                                  
    91                                  check_keyboard:
    92 0000008D B401                        mov ah, 01h
    93 0000008F CD16                        int 16h
    94                                      ; 不断查询键盘缓冲区的状况
    95                                      ; 若有按键，则zf为0，若无按键，则zf为1，跳回去继续查询
    96 00000091 740A                        jz clean_current_char
    97                                      ; 有字符输入,从al中读取键盘输入
    98 00000093 B400                        mov ah, 00h
    99 00000095 CD16                        int 16h
   100                                  
   101 00000097 3C71                        cmp al, 'q' ; 如果键入q则退出
   102 00000099 75F2                        jnz check_keyboard
   103 0000009B CD40                    	int 40h
   104                                  clean_current_char: ; 清除当前字母所占显存位置,准备画下一个字母显存
   105 0000009D 31C0                          xor ax,ax                 ; 计算显存地址
   106 0000009F A1[5501]                      mov ax,word[x]
   107 000000A2 BB5000                  	mov bx,80
   108 000000A5 F7E3                    	mul bx
   109 000000A7 0306[5901]              	add ax,word[y]
   110 000000AB BB0200                  	mov bx,2
   111 000000AE F7E3                    	mul bx
   112 000000B0 89C3                    	mov bx,ax
   113 000000B2 B407                    	mov ah,07h				
   114 000000B4 B020                    	mov al,20h		
   115 000000B6 658907                  	mov [gs:bx],ax  		;  显示字符的ASCII码值
   116                                  
   117                                  check_x:
   118 000000B9 B80100                      mov ax, user2_bound_x_up
   119 000000BC 3906[5501]                  cmp word [x], ax
   120 000000C0 740B                        jz toggle_x_direct
   121 000000C2 B80C00                      mov ax, user2_bound_x_down
   122 000000C5 3906[5501]                  cmp word [x], ax
   123 000000C9 7402                        jz toggle_x_direct
   124 000000CB EB0A                        jmp check_y
   125                                  toggle_x_direct:
   126 000000CD B80000                      mov ax, 0
   127 000000D0 2B06[5701]                  sub ax, word [x_direct]
   128 000000D4 A3[5701]                    mov word [x_direct], ax
   129                                  check_y:
   130 000000D7 B82800                      mov ax, user2_bound_y_left
   131 000000DA 3906[5901]                  cmp word [y], ax
   132 000000DE 740B                        jz toggle_y_direct
   133 000000E0 B84E00                      mov ax, user2_bound_y_right
   134 000000E3 3906[5901]                  cmp word [y], ax
   135 000000E7 7402                        jz toggle_y_direct
   136 000000E9 EB0A                        jmp char_move
   137                                  toggle_y_direct:    
   138 000000EB B80000                      mov ax, 0
   139 000000EE 2B06[5B01]                  sub ax, word [y_direct]
   140 000000F2 A3[5B01]                    mov word [y_direct], ax
   141                                  
   142                                  char_move:
   143 000000F5 A1[5701]                    mov ax, word [x_direct]
   144 000000F8 0106[5501]                  add word [x], ax
   145 000000FC A1[5B01]                    mov ax, word [y_direct]
   146 000000FF 0106[5901]                  add word [y], ax
   147                                  show:	
   148 00000103 31C0                        xor ax,ax                 ; 计算显存地址
   149 00000105 A1[5501]                    mov ax,word[x]
   150 00000108 BB5000                  	mov bx,80
   151 0000010B F7E3                    	mul bx
   152 0000010D 0306[5901]              	add ax,word[y]
   153 00000111 BB0200                  	mov bx,2
   154 00000114 F7E3                    	mul bx
   155 00000116 89C3                    	mov bx,ax
   156 00000118 88FC                    	mov ah,bh				;  0000：黑底、1111：亮白字（默认值为07h）
   157 0000011A A0[5D01]                	mov al,byte[char]			;  AL = 显示字符值（默认值为20h=空格符）
   158 0000011D 658907                  	mov [gs:bx],ax  		;  显示字符的ASCII码值
   159 00000120 E94CFF                  	jmp loop1
   160                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   161                                  ; 清屏函数
   162                                  ; 被调用函数不保存任何寄存器,需要改进	
   163                                  clean_screen:
   164                                  	; 存放寄存器
   165 00000123 50                      	push ax
   166 00000124 51                      	push cx
   167 00000125 56                      	push si
   168 00000126 06                      	push es
   169                                  	; 设置段寄存器
   170 00000127 B800B8                  	mov ax, 0xB800
   171 0000012A 8EC0                    	mov es, ax
   172 0000012C B9D007                  	mov cx, 2000
   173 0000012F BE0000                  	mov si, 0
   174                                  clean_screen_loop:
   175 00000132 26C60420                	mov byte [es:si], 20h
   176 00000136 46                      	inc si
   177 00000137 26C60407                	mov byte [es:si], 07h
   178 0000013B 46                      	inc si
   179 0000013C E2F4                    	loop clean_screen_loop
   180                                  clean_screen_exit:
   181                                  
   182 0000013E B800B8                      mov ax, 0b800h
   183 00000141 8EC0                        mov es, ax
   184 00000143 B80207                      mov ax, 0702h
   185 00000146 26A30000                    mov [es:0x00], ax
   186                                  
   187 0000014A 07                      	pop es
   188 0000014B 5E                      	pop si
   189 0000014C 59                      	pop cx
   190 0000014D 58                      	pop ax
   191 0000014E C3                      	ret
   192                                  
   193                                  end:
   194 0000014F EBFE                        jmp $                   ; 停止画框，无限循环 
   195                                  
   196                                  datadef:	
   197 00000151 50C3                        count dw delay
   198 00000153 0500                        dcount dw ddelay
   199 00000155 0200                        x    dw user2_bound_x_up+1
   200 00000157 0100                        x_direct dw 1
   201 00000159 2900                        y    dw user2_bound_y_left+1
   202 0000015B 0100                        y_direct dw 1
   203 0000015D 02                          char db 2
   204                                  
